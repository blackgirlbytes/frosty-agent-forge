name: Post Daily Challenge to GitHub Discussions

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'
  
  # Production: Scheduled for noon ET (17:00 UTC)
  # Challenges unlock at noon ET = 17:00 UTC (12pm Eastern Time)
  schedule:
    # Days 1-5: Dec 1-5 (Mon-Fri)
    - cron: '0 17 1 12 *'  # Dec 1 at noon ET
    - cron: '0 17 2 12 *'  # Dec 2 at noon ET
    - cron: '0 17 3 12 *'  # Dec 3 at noon ET
    - cron: '0 17 4 12 *'  # Dec 4 at noon ET
    - cron: '0 17 5 12 *'  # Dec 5 at noon ET
    # Days 6-10: Dec 8-12 (Mon-Fri)
    - cron: '0 17 8 12 *'  # Dec 8 at noon ET
    - cron: '0 17 9 12 *'  # Dec 9 at noon ET
    - cron: '0 17 10 12 *' # Dec 10 at noon ET
    - cron: '0 17 11 12 *' # Dec 11 at noon ET
    - cron: '0 17 12 12 *' # Dec 12 at noon ET
    # Days 11-17: Dec 15-19, 22-23 (Mon-Fri)
    - cron: '0 17 15 12 *' # Dec 15 at noon ET
    - cron: '0 17 16 12 *' # Dec 16 at noon ET
    - cron: '0 17 17 12 *' # Dec 17 at noon ET
    - cron: '0 17 18 12 *' # Dec 18 at noon ET
    - cron: '0 17 19 12 *' # Dec 19 at noon ET
    - cron: '0 17 22 12 *' # Dec 22 at noon ET
    - cron: '0 17 23 12 *' # Dec 23 at noon ET

jobs:
  post-challenge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Determine challenge day
        id: determine-day
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "day=${{ github.event.inputs.day }}" >> $GITHUB_OUTPUT
          else
            # Map December dates to challenge days
            declare -A date_to_day=(
              [1]=1 [2]=2 [3]=3 [4]=4 [5]=5
              [8]=6 [9]=7 [10]=8 [11]=9 [12]=10
              [15]=11 [16]=12 [17]=13 [18]=14 [19]=15
              [22]=16 [23]=17
            )
            current_date=$(date -u +%d | sed 's/^0//')
            day=${date_to_day[$current_date]}
            echo "day=$day" >> $GITHUB_OUTPUT
          fi
      
      - name: Post to GitHub Discussions
        env:
          GITHUB_TOKEN: ${{ secrets.DISCUSSIONS_TOKEN }}
          DISCUSSION_CATEGORY_ID: ${{ secrets.DISCUSSION_CATEGORY_ID }}
          TARGET_REPOSITORY: block/goose
          CHALLENGE_DAY: ${{ steps.determine-day.outputs.day }}
        run: |
          npx tsx scripts/github/post-discussion.ts
      
      - name: Commit discussion metadata
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/day${{ steps.determine-day.outputs.day }}-discussion.json
          git commit -m "feat: Add Day ${{ steps.determine-day.outputs.day }} discussion metadata [skip ci]" || echo "No changes to commit"
          git push
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Failed to post Day ${{ steps.determine-day.outputs.day }} challenge`,
              body: 'The automated challenge posting workflow failed. Please check the logs and post manually.',
              labels: ['bug', 'advent-of-ai']
            })
