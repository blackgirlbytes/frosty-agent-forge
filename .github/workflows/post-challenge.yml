name: Post Daily Challenge to GitHub Discussions

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'
  
  # TESTING: Scheduled for 5:40 AM ET (10:40 UTC) for testing
  # TODO: Change back to noon ET (17:00 UTC) after testing
  # Production: noon ET = 17:00 UTC (5pm UTC during EST)
  schedule:
    # Days 1-5: Dec 1-5 (Mon-Fri)
    - cron: '40 10 1 12 *'  # Dec 1 at 5:40 AM ET (TESTING)
    - cron: '40 10 2 12 *'  # Dec 2 at 5:40 AM ET (TESTING)
    - cron: '40 10 3 12 *'  # Dec 3 at 5:40 AM ET (TESTING)
    - cron: '40 10 4 12 *'  # Dec 4 at 5:40 AM ET (TESTING)
    - cron: '40 10 5 12 *'  # Dec 5 at 5:40 AM ET (TESTING)
    # Days 6-10: Dec 8-12 (Mon-Fri)
    - cron: '40 10 8 12 *'  # Dec 8 at 5:40 AM ET (TESTING)
    - cron: '40 10 9 12 *'  # Dec 9 at 5:40 AM ET (TESTING)
    - cron: '40 10 10 12 *' # Dec 10 at 5:40 AM ET (TESTING)
    - cron: '40 10 11 12 *' # Dec 11 at 5:40 AM ET (TESTING)
    - cron: '40 10 12 12 *' # Dec 12 at 5:40 AM ET (TESTING)
    # Days 11-17: Dec 15-19, 22-23 (Mon-Fri)
    - cron: '40 10 15 12 *' # Dec 15 at 5:40 AM ET (TESTING)
    - cron: '40 10 16 12 *' # Dec 16 at 5:40 AM ET (TESTING)
    - cron: '40 10 17 12 *' # Dec 17 at 5:40 AM ET (TESTING)
    - cron: '40 10 18 12 *' # Dec 18 at 5:40 AM ET (TESTING)
    - cron: '40 10 19 12 *' # Dec 19 at 5:40 AM ET (TESTING)
    - cron: '40 10 22 12 *' # Dec 22 at 5:40 AM ET (TESTING)
    - cron: '40 10 23 12 *' # Dec 23 at 5:40 AM ET (TESTING)

jobs:
  post-challenge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Determine challenge day
        id: determine-day
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "day=${{ github.event.inputs.day }}" >> $GITHUB_OUTPUT
          else
            # Map December dates to challenge days
            declare -A date_to_day=(
              [1]=1 [2]=2 [3]=3 [4]=4 [5]=5
              [8]=6 [9]=7 [10]=8 [11]=9 [12]=10
              [15]=11 [16]=12 [17]=13 [18]=14 [19]=15
              [22]=16 [23]=17
            )
            current_date=$(date -u +%d | sed 's/^0//')
            day=${date_to_day[$current_date]}
            echo "day=$day" >> $GITHUB_OUTPUT
          fi
      
      - name: Post to GitHub Discussions
        env:
          GITHUB_TOKEN: ${{ secrets.DISCUSSIONS_TOKEN }}
          GITHUB_REPOSITORY: block/goose
          CHALLENGE_DAY: ${{ steps.determine-day.outputs.day }}
        run: |
          npx tsx scripts/github/post-discussion.ts
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Failed to post Day ${{ steps.determine-day.outputs.day }} challenge`,
              body: 'The automated challenge posting workflow failed. Please check the logs and post manually.',
              labels: ['bug', 'advent-of-ai']
            })
