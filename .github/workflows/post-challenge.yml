name: Post Daily Challenge to GitHub Discussions

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'
  
  # Scheduled posting at noon ET (5pm UTC during EST, 4pm UTC during EDT)
  # December is EST (UTC-5), so noon ET = 5pm UTC
  schedule:
    # Days 1-5: Dec 1-5 (Mon-Fri)
    - cron: '0 17 1 12 *'  # Dec 1
    - cron: '0 17 2 12 *'  # Dec 2
    - cron: '0 17 3 12 *'  # Dec 3
    - cron: '0 17 4 12 *'  # Dec 4
    - cron: '0 17 5 12 *'  # Dec 5
    # Days 6-10: Dec 8-12 (Mon-Fri)
    - cron: '0 17 8 12 *'  # Dec 8
    - cron: '0 17 9 12 *'  # Dec 9
    - cron: '0 17 10 12 *' # Dec 10
    - cron: '0 17 11 12 *' # Dec 11
    - cron: '0 17 12 12 *' # Dec 12
    # Days 11-17: Dec 15-19, 22-23 (Mon-Fri)
    - cron: '0 17 15 12 *' # Dec 15
    - cron: '0 17 16 12 *' # Dec 16
    - cron: '0 17 17 12 *' # Dec 17
    - cron: '0 17 18 12 *' # Dec 18
    - cron: '0 17 19 12 *' # Dec 19
    - cron: '0 17 22 12 *' # Dec 22
    - cron: '0 17 23 12 *' # Dec 23

jobs:
  post-challenge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Determine challenge day
        id: determine-day
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "day=${{ github.event.inputs.day }}" >> $GITHUB_OUTPUT
          else
            # Map December dates to challenge days
            declare -A date_to_day=(
              [1]=1 [2]=2 [3]=3 [4]=4 [5]=5
              [8]=6 [9]=7 [10]=8 [11]=9 [12]=10
              [15]=11 [16]=12 [17]=13 [18]=14 [19]=15
              [22]=16 [23]=17
            )
            current_date=$(date -u +%d | sed 's/^0//')
            day=${date_to_day[$current_date]}
            echo "day=$day" >> $GITHUB_OUTPUT
          fi
      
      - name: Post to GitHub Discussions
        env:
          GITHUB_TOKEN: ${{ secrets.DISCUSSIONS_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CHALLENGE_DAY: ${{ steps.determine-day.outputs.day }}
        run: |
          npx tsx scripts/github/post-discussion.ts
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Failed to post Day ${{ steps.determine-day.outputs.day }} challenge`,
              body: 'The automated challenge posting workflow failed. Please check the logs and post manually.',
              labels: ['bug', 'advent-of-ai']
            })
