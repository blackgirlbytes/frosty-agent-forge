name: Send Daily Challenge Email Notifications

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      day:
        description: 'Challenge day number (1-17)'
        required: true
        default: '1'
      dry_run:
        description: 'Dry run (test without sending emails)'
        required: false
        type: boolean
        default: false
  
  # Production: Scheduled for 12:00 PM ET (17:00 UTC) when challenges unlock
  schedule:
    # Days 1-5: Dec 1-5 (Mon-Fri)
    - cron: '0 17 1 12 *'  # Dec 1 at 12 PM ET
    - cron: '0 17 2 12 *'  # Dec 2 at 12 PM ET
    - cron: '0 17 3 12 *'  # Dec 3 at 12 PM ET
    - cron: '0 17 4 12 *'  # Dec 4 at 12 PM ET
    - cron: '0 17 5 12 *'  # Dec 5 at 12 PM ET
    # Days 6-10: Dec 8-12 (Mon-Fri)
    - cron: '0 17 8 12 *'  # Dec 8 at 12 PM ET
    - cron: '0 17 9 12 *'  # Dec 9 at 12 PM ET
    - cron: '0 17 10 12 *' # Dec 10 at 12 PM ET
    - cron: '0 17 11 12 *' # Dec 11 at 12 PM ET
    - cron: '0 17 12 12 *' # Dec 12 at 12 PM ET
    # Days 11-17: Dec 15-19, 22-23 (Mon-Fri)
    - cron: '0 17 15 12 *' # Dec 15 at 12 PM ET
    - cron: '0 17 16 12 *' # Dec 16 at 12 PM ET
    - cron: '0 17 17 12 *' # Dec 17 at 12 PM ET
    - cron: '0 17 18 12 *' # Dec 18 at 12 PM ET
    - cron: '0 17 19 12 *' # Dec 19 at 12 PM ET
    - cron: '0 17 22 12 *' # Dec 22 at 12 PM ET
    - cron: '0 17 23 12 *' # Dec 23 at 12 PM ET

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Determine challenge day
        id: determine-day
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "day=${{ github.event.inputs.day }}" >> $GITHUB_OUTPUT
          else
            # Map December dates to challenge days
            declare -A date_to_day=(
              [1]=1 [2]=2 [3]=3 [4]=4 [5]=5
              [8]=6 [9]=7 [10]=8 [11]=9 [12]=10
              [15]=11 [16]=12 [17]=13 [18]=14 [19]=15
              [22]=16 [23]=17
            )
            current_date=$(date -u +%d | sed 's/^0//')
            day=${date_to_day[$current_date]}
            echo "day=$day" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Send email notifications
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª DRY RUN MODE - No emails will be sent"
            npx tsx scripts/send-notification.ts --day=${{ steps.determine-day.outputs.day }} --dry-run --railway
          else
            npx tsx scripts/send-notification.ts --day=${{ steps.determine-day.outputs.day }} --railway
          fi
      
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Email Notifications Sent Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ steps.determine-day.outputs.day }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed statistics." >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Failed to send Day ${{ steps.determine-day.outputs.day }} email notifications`,
              body: `The automated email notification workflow failed. Please check the logs and send manually.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'advent-of-ai', 'email-notifications']
            })
